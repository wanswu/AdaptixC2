name: Build Adaptix C2

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: write

jobs:
  build-server:
    name: Build Server and Extenders
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo chmod +x ./pre_install_linux.sh && ./pre_install_linux.sh
    
    - name: Cache build artifacts
      uses: actions/checkout@v6
      with:
        path: |
          dist
        key: ${{ runner.os }}-server-${{ matrix.arch }}-${{ hashFiles('server/**', 'extenders/**', 'Makefile') }}
        restore-keys: |
          ${{ runner.os }}-server-${{ matrix.arch }}-
    
    - name: Build all
      run: make server-ext


    - name: Upload server artifacts
      uses: actions/upload-artifact@v6
      with:
        name: server-${{ matrix.os }}-${{ matrix.arch }}
        path: dist/*

  build-client-macos:
    name: Build Client for macOS (${{ matrix.runner == 'macos-15' && 'Intel' || 'Apple Silicon' }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: macos-15-intel
            arch: amd64
          - runner: macos-latest
            arch: arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        persist-credentials: false
    
    - name: Cache Homebrew dependencies
      uses: actions/cache@v5
      with:
        path: /usr/local/Homebrew
        key: ${{ runner.os }}-homebrew-${{ hashFiles('pre_install_macos.sh') }}
        restore-keys: |
          ${{ runner.os }}-homebrew-
    
    - name: Install dependencies
      run: |
        brew update
        if brew list cmake &>/dev/null; then
          echo "Uninstalling existing cmake..."
          brew uninstall cmake
        fi
        sudo chmod +x ./pre_install_macos.sh && ./pre_install_macos.sh
    
    - name: Cache build artifacts
      uses: actions/cache@v5
      with:
        path: |
          AdaptixClient/build
          dist
        key: ${{ runner.os }}-client-${{ matrix.arch }}-${{ hashFiles('AdaptixClient/**', 'Makefile') }}
        restore-keys: |
          ${{ runner.os }}-client-${{ matrix.arch }}-
    
    - name: Build client
      run: make client
    
    - name: Upload client artifacts
      uses: actions/upload-artifact@v6
      with:
        name: client-macos-${{ matrix.arch }}
        path: dist/AdaptixClient

  build-client-windows-amd64:
    name: Build Client for Windows (x64)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.6.*'
        modules: 'qtwebsockets'
        arch: 'win64_msvc2019_64'
        cache: true
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Configure CMake
      run: |
        cd AdaptixClient
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -A x64
    
    - name: Build
      working-directory: AdaptixClient/build
      run: cmake --build . --config Release
    
    - name: Package with dependencies
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "dist-windows"
        
        $exeFile = Get-ChildItem -Path "AdaptixClient\build" -Filter "*.exe" -Recurse | 
                   Where-Object { $_.Name -like "*AdaptixClient*" -or $_.Name -like "*Adaptix*" } | 
                   Select-Object -First 1
        
        if ($exeFile) {
          Write-Host "Found executable: $($exeFile.FullName)"
          Copy-Item $exeFile.FullName -Destination "dist-windows\"
          
          $qtBin = "$env:Qt6_DIR\bin"
          & "$qtBin\windeployqt.exe" "dist-windows\$($exeFile.Name)"
        } else {
          Write-Host "Warning: Could not find AdaptixClient executable"
          Get-ChildItem -Path "AdaptixClient\build\Release" -Filter "*.exe" -ErrorAction SilentlyContinue | 
            ForEach-Object {
              Copy-Item $_.FullName -Destination "dist-windows\"
              & "$qtBin\windeployqt.exe" "dist-windows\$($_.Name)"
            }
        }
    
    - name: Upload client artifacts
      uses: actions/upload-artifact@v6
      with:
        name: client-windows-amd64
        path: dist-windows/*

  create-release:
    name: Create Release
    needs: [
      build-server,
      build-client-macos,
      build-client-windows-amd64
    ]
    runs-on: ubuntu-latest
    if: success() && github.ref == 'refs/heads/main'  # 仅在提交到 main 分支时创建 Release
    continue-on-error: true
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Get version number
      id: version
      run: |
        # 从 README.md 第一行提取版本号（格式：# AdaptixC2 vX.Y）
        if [ -f "README.md" ]; then
          VERSION=$(head -n 1 README.md | grep -o 'v[0-9]\+\.[0-9]\+\(\.[0-9]\+\)\?')
          if [ -z "$VERSION" ]; then
            echo "No valid version found in README.md, using default version 0.0.0"
            echo "version=0.0.0" >> $GITHUB_OUTPUT
          else
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi
        else
          echo "README.md not found, using default version 0.0.0"
          echo "version=0.0.0" >> $GITHUB_OUTPUT
        fi
    
    - name: Download all artifacts
      uses: actions/download-artifact@v7
      with:
        path: artifacts
    
    - name: Display structure
      run: |
        echo "=== Artifacts structure ==="
        ls -la artifacts/
        echo "=== Content of each artifact ==="
        for dir in artifacts/*/; do
          echo "Content of $dir:"
          ls -la "$dir"
        done
    
    - name: Package artifacts
      run: |
        cd artifacts
        for dir in */; do
          dirname="${dir%/}"
          if [[ $dirname == *"server"* ]]; then
            zipname="AdaptixC2-Server-${dirname#*-}.zip"
          else
            zipname="AdaptixC2-Client-${dirname#*-}.zip"
          fi
          zip -r "$zipname" "$dir"
        done
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "${{ steps.version.outputs.version }}"
        name: "Adaptix C2 Release ${{ steps.version.outputs.version }}"
        draft: false
        prerelease: false
        files: |
          artifacts/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}